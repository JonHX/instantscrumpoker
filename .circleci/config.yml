version: 2.1

orbs:
  aws-cli: circleci/aws-cli@5.2.0

jobs:
  build-deploy-scrumpoker:
    docker:
      - image: cimg/node:20
    working_directory: ~/repo/lambda
    steps:
      - checkout:
          path: ~/repo
      - run:
          name: Install dependencies
          command: npm ci
      - aws-cli/setup:
          region: eu-west-1
      - run:
          name: Install SAM CLI
          command: |
            pip install aws-sam-cli
      - run:
          name: Build Lambda package
          command: |
            chmod +x build-sam.sh
            ./build-sam.sh
      - run:
          name: Build with SAM
          command: sam build
      - run:
          name: Verify AWS credentials
          command: aws sts get-caller-identity
      - run:
          name: Deploy with SAM
          command: |
            sam deploy \
              --stack-name scrumpoker-stack \
              --resolve-s3 \
              --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
              --region ${AWS_DEFAULT_REGION:-eu-west-1} \
              --no-fail-on-empty-changeset \
              --parameter-overrides \
                Environment=${ENVIRONMENT:-dev}
      - run:
          name: Get API URLs
          command: |
            echo "HTTP API URL:"
            aws cloudformation describe-stacks \
              --stack-name scrumpoker-stack \
              --region ${AWS_DEFAULT_REGION:-eu-west-1} \
              --query "Stacks[0].Outputs[?OutputKey=='HttpApiUrl'].OutputValue" \
              --output text
            echo "WebSocket API URL:"
            aws cloudformation describe-stacks \
              --stack-name scrumpoker-stack \
              --region ${AWS_DEFAULT_REGION:-eu-west-1} \
              --query "Stacks[0].Outputs[?OutputKey=='WebSocketApiUrl'].OutputValue" \
              --output text

workflows:
  version: 2
  deploy:
    jobs:
      - build-deploy-scrumpoker:
          context:
            - aws-credentials
          filters:
            branches:
              only: main

