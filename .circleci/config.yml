version: 2.1

orbs:
  aws-cli: circleci/aws-cli@5.2.0

jobs:
  build-deploy-scrumpoker:
    docker:
      - image: cimg/node:20.11
    working_directory: ~/repo/lambda
    steps:
      - checkout:
          path: ~/repo
      - run:
          name: Install SAM CLI (binary, no Python needed)
          command: |
            curl -L "https://github.com/aws/aws-sam-cli/releases/latest/download/aws-sam-cli-linux-x86_64.zip" -o "aws-sam-cli.zip"
            unzip aws-sam-cli.zip -d sam-installation
            sudo ./sam-installation/install
            sam --version
      - run:
          name: Install dependencies
          command: npm ci
      - aws-cli/setup:
          region: eu-west-1
      - run:
          name: Build Lambda package
          command: |
            chmod +x build-sam.sh
            ./build-sam.sh
      - run:
          name: Build with SAM
          command: sam build
      - run:
          name: Verify AWS credentials
          command: aws sts get-caller-identity
      - run:
          name: Check and delete failed stack if needed
          command: |
            STACK_STATUS=$(aws cloudformation describe-stacks \
              --stack-name scrumpoker-stack \
              --region ${AWS_DEFAULT_REGION:-eu-west-1} \
              --query "Stacks[0].StackStatus" \
              --output text 2>/dev/null || echo "NOT_FOUND")
            
            if [ "$STACK_STATUS" = "ROLLBACK_COMPLETE" ] || [ "$STACK_STATUS" = "CREATE_FAILED" ]; then
              echo "Stack is in $STACK_STATUS state. Deleting before redeploy..."
              aws cloudformation delete-stack \
                --stack-name scrumpoker-stack \
                --region ${AWS_DEFAULT_REGION:-eu-west-1}
              
              echo "Waiting for stack deletion to complete..."
              aws cloudformation wait stack-delete-complete \
                --stack-name scrumpoker-stack \
                --region ${AWS_DEFAULT_REGION:-eu-west-1}
              
              echo "Stack deleted successfully. Ready for new deployment."
            elif [ "$STACK_STATUS" = "NOT_FOUND" ]; then
              echo "Stack does not exist. Ready for new deployment."
            else
              echo "Stack exists with status: $STACK_STATUS. Proceeding with update."
            fi
      - run:
          name: Deploy with SAM
          command: |
            sam deploy \
              --stack-name scrumpoker-stack \
              --resolve-s3 \
              --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
              --region ${AWS_DEFAULT_REGION:-eu-west-1} \
              --no-fail-on-empty-changeset \
              --parameter-overrides \
                Environment=${ENVIRONMENT:-dev}
      - run:
          name: Get API URLs and S3 bucket name
          command: |
            HTTP_API_URL=$(aws cloudformation describe-stacks \
              --stack-name scrumpoker-stack \
              --region ${AWS_DEFAULT_REGION:-eu-west-1} \
              --query "Stacks[0].Outputs[?OutputKey=='HttpApiUrl'].OutputValue" \
              --output text)
            WS_API_URL=$(aws cloudformation describe-stacks \
              --stack-name scrumpoker-stack \
              --region ${AWS_DEFAULT_REGION:-eu-west-1} \
              --query "Stacks[0].Outputs[?OutputKey=='WebSocketApiUrl'].OutputValue" \
              --output text)
            S3_BUCKET=$(aws cloudformation describe-stacks \
              --stack-name scrumpoker-stack \
              --region ${AWS_DEFAULT_REGION:-eu-west-1} \
              --query "Stacks[0].Outputs[?OutputKey=='FrontendBucketName'].OutputValue" \
              --output text)
            echo "HTTP API URL: $HTTP_API_URL"
            echo "WebSocket API URL: $WS_API_URL"
            echo "S3 Bucket: $S3_BUCKET"
            echo "export HTTP_API_URL=$HTTP_API_URL" >> $BASH_ENV
            echo "export WS_API_URL=$WS_API_URL" >> $BASH_ENV
            echo "export S3_BUCKET=$S3_BUCKET" >> $BASH_ENV
      - run:
          name: Build Next.js frontend
          working_directory: ~/repo
          command: |
            cd ~/repo
            npm ci
            # API_BASE_URL should be the base URL without /api (the API client will add it)
            NEXT_PUBLIC_API_BASE_URL="${HTTP_API_URL}" NEXT_PUBLIC_WS_ENDPOINT="$WS_API_URL" npm run build
      - run:
          name: Upload frontend to S3
          command: |
            if [ -d "$HOME/repo/out" ]; then
              echo "Uploading frontend files to S3 bucket: $S3_BUCKET"
              # Upload static assets with long cache
              aws s3 sync $HOME/repo/out/ s3://$S3_BUCKET/ \
                --region ${AWS_DEFAULT_REGION:-eu-west-1} \
                --delete \
                --cache-control "public, max-age=31536000, immutable" \
                --exclude "*.html" \
                --exclude "*.json"
              # Upload HTML and JSON files with no-cache
              aws s3 sync $HOME/repo/out/ s3://$S3_BUCKET/ \
                --region ${AWS_DEFAULT_REGION:-eu-west-1} \
                --cache-control "no-cache, no-store, must-revalidate" \
                --exclude "*" \
                --include "*.html" \
                --include "*.json"
              # Configure S3 bucket website to serve index.html for all routes (SPA pattern)
              # This allows Next.js client-side routing to handle all routes
              echo "Configuring S3 bucket website for SPA routing..."
              aws s3api put-bucket-website \
                --bucket "$S3_BUCKET" \
                --region ${AWS_DEFAULT_REGION:-eu-west-1} \
                --website-configuration "{
                  \"IndexDocument\": {\"Suffix\": \"index.html\"},
                  \"ErrorDocument\": {\"Key\": \"index.html\"}
                }" || echo "Warning: Could not update bucket website configuration (may need manual update)"
              echo "Frontend uploaded successfully!"
              echo "Website URL: http://$S3_BUCKET.s3-website-${AWS_DEFAULT_REGION:-eu-west-1}.amazonaws.com"
            else
              echo "ERROR: $HOME/repo/out directory not found. Build may have failed."
              exit 1
            fi

workflows:
  version: 2
  deploy:
    jobs:
      - build-deploy-scrumpoker:
          context:
            - aws-credentials
          filters:
            branches:
              only: main

