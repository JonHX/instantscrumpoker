version: 2.1

orbs:
  aws-cli: circleci/aws-cli@5.2.0

jobs:
  build-deploy-scrumpoker:
    docker:
      - image: cimg/node:20.11
    working_directory: ~/repo/lambda
    steps:
      - checkout:
          path: ~/repo
      - run:
          name: Install SAM CLI (binary, no Python needed)
          command: |
            curl -L "https://github.com/aws/aws-sam-cli/releases/latest/download/aws-sam-cli-linux-x86_64.zip" -o "aws-sam-cli.zip"
            unzip aws-sam-cli.zip -d sam-installation
            sudo ./sam-installation/install
            sam --version
      - run:
          name: Install dependencies
          command: npm ci
      - aws-cli/setup:
          region: eu-west-1
      - run:
          name: Build Lambda package
          command: |
            chmod +x build-sam.sh
            ./build-sam.sh
      - run:
          name: Build with SAM
          command: sam build
      - run:
          name: Verify AWS credentials
          command: aws sts get-caller-identity
      - run:
          name: Check and delete failed stack if needed
          command: |
            STACK_STATUS=$(aws cloudformation describe-stacks \
              --stack-name scrumpoker-stack \
              --region ${AWS_DEFAULT_REGION:-eu-west-1} \
              --query "Stacks[0].StackStatus" \
              --output text 2>/dev/null || echo "NOT_FOUND")
            
            if [ "$STACK_STATUS" = "ROLLBACK_COMPLETE" ] || [ "$STACK_STATUS" = "CREATE_FAILED" ]; then
              echo "Stack is in $STACK_STATUS state. Deleting before redeploy..."
              aws cloudformation delete-stack \
                --stack-name scrumpoker-stack \
                --region ${AWS_DEFAULT_REGION:-eu-west-1}
              
              echo "Waiting for stack deletion to complete..."
              aws cloudformation wait stack-delete-complete \
                --stack-name scrumpoker-stack \
                --region ${AWS_DEFAULT_REGION:-eu-west-1}
              
              echo "Stack deleted successfully. Ready for new deployment."
            elif [ "$STACK_STATUS" = "NOT_FOUND" ]; then
              echo "Stack does not exist. Ready for new deployment."
            else
              echo "Stack exists with status: $STACK_STATUS. Proceeding with update."
            fi
      - run:
          name: Deploy with SAM
          command: |
            sam deploy \
              --stack-name scrumpoker-stack \
              --resolve-s3 \
              --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
              --region ${AWS_DEFAULT_REGION:-eu-west-1} \
              --no-fail-on-empty-changeset \
              --parameter-overrides \
                Environment=${ENVIRONMENT:-dev}
      - run:
          name: Get API URLs
          command: |
            echo "HTTP API URL:"
            aws cloudformation describe-stacks \
              --stack-name scrumpoker-stack \
              --region ${AWS_DEFAULT_REGION:-eu-west-1} \
              --query "Stacks[0].Outputs[?OutputKey=='HttpApiUrl'].OutputValue" \
              --output text
            echo "WebSocket API URL:"
            aws cloudformation describe-stacks \
              --stack-name scrumpoker-stack \
              --region ${AWS_DEFAULT_REGION:-eu-west-1} \
              --query "Stacks[0].Outputs[?OutputKey=='WebSocketApiUrl'].OutputValue" \
              --output text

workflows:
  version: 2
  deploy:
    jobs:
      - build-deploy-scrumpoker:
          context:
            - aws-credentials
          filters:
            branches:
              only: main

